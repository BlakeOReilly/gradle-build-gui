<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Gradle Build GUI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/static/styles.css" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <h1>Gradle Build GUI</h1>

    <label for="project_root">Project root or any path inside the project</label>
    <input id="project_root" type="text" placeholder="C:\repo or /home/user/repo">
    <button id="check_btn">Check</button>

    <div id="status" class="status unknown">Status: Unknown</div>
    <div id="resolved"></div>
    <div id="gradle_root"></div>

    <button id="run_btn">Run Build</button>

    <h2>Prompt</h2>
    <pre id="prompt_note">Prompt file path will appear after a failed build.</pre>

    <h2>OpenAI Result</h2>
    <pre id="result"></pre>

    <h2>Actions</h2>
    <pre id="actions"></pre>

    <h2>Logs</h2>
    <pre id="logs"></pre>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const projectRoot = $("#project_root");
    const statusEl = $("#status");
    const resolvedEl = $("#resolved");
    const gradleRootEl = $("#gradle_root");
    const resultEl = $("#result");
    const actionsEl = $("#actions");
    const logsEl = $("#logs");
    const promptNote = $("#prompt_note");

    async function post(url, body) {
      const r = await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
      const j = await r.json();
      if (!r.ok) throw j;
      return j;
    }

    $("#check_btn").onclick = async ()=>{
      statusEl.className = "status unknown";
      statusEl.textContent = "Status: checking...";
      try {
        const j = await post("/api/check", {project_root: projectRoot.value});
        statusEl.className = "status " + (j.ok ? "ok" : "bad");
        statusEl.textContent = "Status: " + (j.ok ? "build file found" : "build file NOT found");
        resolvedEl.textContent = "Input resolved to: " + j.resolved_path;
        gradleRootEl.textContent = "Gradle root: " + (j.gradle_root || "(not found)") + (j.reason ? " ["+j.reason+"]" : "");
        if (j.ok && j.gradle_root) {
          projectRoot.value = j.gradle_root; // auto-correct field to discovered root
        }
      } catch (e) {
        statusEl.className = "status bad";
        statusEl.textContent = "Status: error";
        resolvedEl.textContent = JSON.stringify(e, null, 2);
      }
    };

    $("#run_btn").onclick = async ()=>{
      resultEl.textContent = "";
      actionsEl.textContent = "";
      logsEl.textContent = "";
      promptNote.textContent = "Running build...";

      try {
        const j = await post("/api/run", {project_root: projectRoot.value});
        if (j.status === "success") {
          statusEl.className = "status ok";
          statusEl.textContent = "Status: build succeeded";
          logsEl.textContent = "Log: " + j.log_file;
          gradleRootEl.textContent = "Gradle root: " + j.gradle_root;
          promptNote.textContent = "No prompt generated (success).";
          return;
        }
        // Patch applied or validated
        statusEl.className = "status bad";
        statusEl.textContent = "Status: build failed, patch generated";
        resultEl.textContent = JSON.stringify(j.spec, null, 2);
        actionsEl.textContent = (j.actions || []).join("\n");
        if (j.commands && j.commands.length) {
          actionsEl.textContent += "\n\nCommands:\n" + j.commands.map(c => c.cmd + " -> rc=" + c.returncode).join("\n");
        }
        if (j.log_file) logsEl.textContent = "Log: " + j.log_file;
        if (j.prompt_file) promptNote.textContent = "Prompt saved at: " + j.prompt_file;
        if (j.gradle_root) gradleRootEl.textContent = "Gradle root: " + j.gradle_root;
      } catch (e) {
        statusEl.className = "status bad";
        statusEl.textContent = "Status: run error";
        resultEl.textContent = JSON.stringify(e, null, 2);
      }
    };
  </script>
</body>
</html>